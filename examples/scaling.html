<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>cannon.js - Scaling</title>
    <link rel="stylesheet" href="css/style.css" type="text/css" />
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
  </head>
  <body>
    <script type="module">
      import * as CANNON from '../dist/cannon-es.js'
      import { Demo } from './js/Demo.js'

      /**
       * Just a simple body on a plane.
       */

      const demo = new Demo()

      demo.addScene('Sphere', () => {
        const world = setupWorld(demo)

        const size = 2

        const sphereShape = new CANNON.Sphere(size)

        const body = new CANNON.Body({
          mass: 30,
          velocity: new CANNON.Vec3(1, 0, 0),
          angularVelocity: new CANNON.Vec3(1, 3, 0),
        })
        body.addShape(sphereShape)
        body.position.set(0, size * 2, size)
        world.addBody(body)
        demo.addVisual(body)

        demo.addSetTimeout(() => {
          body.scale.set(0.6, 1, 1)
          body.updateScale()
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 400)

        demo.addSetTimeout(() => {
          body.position.set(0, 2 * 2, size)
          body.scale.set(2, 1, 1)
          body.updateScale()
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 1000)
      })

      demo.addScene('Box', () => {
        const world = setupWorld(demo)

        const size = 2

        const boxShape = new CANNON.Box(new CANNON.Vec3(size, size, size))
        const body = new CANNON.Body({
          mass: 30,
          velocity: new CANNON.Vec3(1, 0, 0),
          angularVelocity: new CANNON.Vec3(1, 3, 0),
          scale: new CANNON.Vec3(1, 2, 2),
        })

        body.addShape(boxShape)
        body.position.set(0, size * 4, size)

        demo.addSetTimeout(() => {
          // Can update scale with a new Vec3 but isn't recommended.
          body.updateScale(new CANNON.Vec3(1.2, 1.3, 0.9))
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 1000)

        world.addBody(body)
        demo.addVisual(body)
      })

      demo.addScene('Convex', () => {
        const world = setupWorld(demo)

        function createTetra() {
          const vertices = [
            new CANNON.Vec3(0, 0, 0),
            new CANNON.Vec3(2, 0, 0),
            new CANNON.Vec3(0, 2, 0),
            new CANNON.Vec3(0, 0, 2),
          ]
          const offset = -0.35
          for (let i = 0; i < vertices.length; i++) {
            const v = vertices[i]
            v.x += offset
            v.y += offset
            v.z += offset
          }
          return new CANNON.ConvexPolyhedron({
            vertices: vertices,
            faces: [
              [0, 3, 2], // -x
              [0, 1, 3], // -y
              [0, 2, 1], // -z
              [1, 2, 3], // +xyz
            ],
          })
        }

        // ConvexPolyhedron tetra shape
        const tetraShape = createTetra()
        const body = new CANNON.Body({
          mass: 30,
          velocity: new CANNON.Vec3(1, 0, 0),
          angularVelocity: new CANNON.Vec3(1, 3, 0),
          scale: new CANNON.Vec3(1, 2, 4),
        })
        body.addShape(tetraShape)
        body.position.set(0, 8, 2)

        demo.addSetTimeout(() => {
          body.scale.set(1.2, 1, 1)
          body.updateScale()
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 500)

        world.addBody(body)
        demo.addVisual(body)
      })

      demo.addScene('Cylinder', () => {
        const world = setupWorld(demo)

        const height = 2
        const radius = 0.5
        const detail = 20

        const cylinderShape = new CANNON.Cylinder(radius, radius, height, detail)
        const body = new CANNON.Body({
          mass: 30,
          velocity: new CANNON.Vec3(1, 0, 0),
          angularVelocity: new CANNON.Vec3(1, 3, 0),
          scale: new CANNON.Vec3(4, 4, 4),
        })

        body.addShape(cylinderShape)
        body.position.set(0, height * 4, 2)

        demo.addSetTimeout(() => {
          body.scale.set(1.2, 1, 3)
          body.updateScale()
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 500)

        demo.addSetTimeout(() => {
          body.scale.set(1.2, 1.2, 0.8)
          body.updateScale()
          demo.removeVisual(body)
          demo.addVisual(body)
        }, 2000)

        world.addBody(body)
        demo.addVisual(body)
      })

      demo.addScene('Heightfield', () => {
        const world = setupWorldWNoGround(demo)

        // Create a matrix of height values
        const matrix = []
        const sizeX = 15
        const sizeZ = 15
        const scaleX = 1
        const scaleY = 0.8
        const scaleZ = 1.2

        for (let i = 0; i < sizeX; i++) {
          matrix.push([])
          for (let j = 0; j < sizeZ; j++) {
            if (i === 0 || i === sizeX - 1 || j === 0 || j === sizeZ - 1) {
              const height = 3
              matrix[i].push(height)
              continue
            }

            const height = Math.cos((i / sizeX) * Math.PI * 2) * Math.cos((j / sizeZ) * Math.PI * 2) + 2
            matrix[i].push(height)
          }
        }

        // Create the heightfield
        const heightfieldShape = new CANNON.Heightfield(matrix)
        const heightfieldBody = new CANNON.Body({ mass: 0, scale: new CANNON.Vec3(scaleX, scaleY, scaleZ) })
        heightfieldBody.addShape(heightfieldShape)
        heightfieldBody.position.set(
          -((sizeX - 1) * heightfieldShape.elementSizeX) / 2,
          -4,
          ((sizeZ - 1) * heightfieldShape.elementSizeY) / 2
        )
        heightfieldBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0)
        world.addBody(heightfieldBody)
        demo.addVisual(heightfieldBody)

        // Add spheres
        const mass = 1
        for (let i = 0; i < sizeX - 1; i++) {
          for (let j = 0; j < sizeZ - 1; j++) {
            if (i === 0 || i >= sizeX - 2 || j === 0 || j >= sizeZ - 2) {
              continue
            }

            const sphereShape = new CANNON.Sphere(0.1)
            const sphereBody = new CANNON.Body({ mass })
            sphereBody.addShape(sphereShape)
            sphereBody.position.set((i + 0.25) * scaleX, 4 * scaleZ, (-j + 0.25) * scaleY)
            sphereBody.position.vadd(heightfieldBody.position, sphereBody.position)
            world.addBody(sphereBody)
            demo.addVisual(sphereBody)
          }
        }
      })

      demo.start()

      function setupWorld(demo) {
        const world = demo.getWorld()
        world.gravity.set(0, -10, 0)

        // Tweak contact properties.
        // Contact stiffness - use to make softer/harder contacts
        world.defaultContactMaterial.contactEquationStiffness = 1e7

        // Stabilization time in number of timesteps
        world.defaultContactMaterial.contactEquationRelaxation = 4

        // Static ground plane
        const groundShape = new CANNON.Plane()
        const groundBody = new CANNON.Body({ mass: 0 })
        groundBody.addShape(groundShape)
        groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0)
        world.addBody(groundBody)
        demo.addVisual(groundBody)

        return world
      }

      function setupWorldWNoGround(demo) {
        const world = demo.getWorld()
        world.gravity.set(0, -10, 0)

        return world
      }
    </script>
  </body>
</html>
